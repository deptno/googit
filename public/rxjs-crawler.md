---
date: 2019-02-28
title: RxJS 언제쓰는 것인가?
description: 크롤러를 작성하면서 느낀 RxJS가 필요한 순간과 주의할 점
tags:
  - rxjs
  - crawler
  - 크롤러
---

`rxjs` 를 통해 대형 크롤러를 작성했다. 사실상 API 제한 없는 한 크롤링 봇의 형태로 무한대로 뻗어나가는 형태의 크롤러다. 그리고 다시 기본으로 재구현을 했다. **메모리 이슈**를 간과했다. 😭

## 왜 RxJS 였나?

`rxjs` 가 추구하는 리액티브 프로그래밍은 우아하다. 우아하다는 말이 구현하기 쉽다는 말은 아니다. 다만 구현하고 나면 보기 편하고 잘 읽힌다.

`rxjs` 는 파이프라인을 연결하는 게임과도 같다. 어렸을 적 이런류의 게임을 해본 사람이라면 아마도 코드를 작성하면서 파이프가 머리속에 그려지리라.  
특히 사이드이펙트를 위한 분기 오퍼레이터 이름은 `tap` 인데 함수형에서 많이 쓰이는 이 이름은 아마도 수도꼭지를 의미하지 않나 싶다.  
결국 함수형 프로그래밍의 패러다임 또한 데이터를 흘리는 형태다. Rx는 루프를 통해 데이터를 생산하는 형태를 옵저버블과 서브젝트를 통해 데이터를 연속적으로 흘려보낼 수 있는 형태로 추상화 되었다.

주어진 오퍼레이터는 파이프다. 이를 연결해서 데이터 흐름도를 맞춰 원하는 형태의 데이터를 만든다. 만들고나면 물을 흘려보내듯 서브젝트에서 데이터를 내보내기 시작한다.  
이런 형태의 리엑티브 프로그래밍을 적용하기 적절한 요구사항은 무엇이 있을까?

### 클릭스트림 그리고 크롤러

클릭스트림, 예를 들어 드래그와 같은 형태가 가장 적절하고 신선하다. 때문에 많은 책들이 이를 예로 든다. 그리고 난 **연속성**이 있는 크롤링 봇에 적절할 것이라고 생각했다.

## 크롤링 파이프라인을 설계하며

구글의 크롤링 봇처럼 페이지를 찾고 페이지내의 링크를 찾는 형태로 계속 돌아다닌다고 가정해보자.  
결국 링크를 타고 안으로 들어가면 역시 또 페이지다. 그럼 페이지 링크(URL)를 입력받아 웹페이지를 파싱하고 그 페이지가 가지는 여러개의 링크를 출력하는 처리하는 파이프라인을 설계한다.  
여러개의 링크 각각은 역시 링크이므로 다시 설계한 파이프라인의 입력값으로 들어가게 되어 루프를 형성한다.  
그리고 이 루프를 끝낼 수 있도록 파이프라인이 처리할 수 있는 링크의 양을 설정한다.

### 적절(적합)했나? 무엇이 좋았나?

개인적으로 즐겁게 코딩할 수 있었다.. 사실 2016에도 `redux-observable` 을 사용하다가 발을 뺀적이 있었는데, 현재의 `rxjs` 는 그 떄보다 훨씬 나은 구조를 가지고 있다고 보여진다.  
오퍼레이터와 팩토리가 분리되었고 `do` 보다는 열배는 더 적합해 보이는 `tap` 등의 네이밍도 마음에 든다. 

또한 `rxjs` 의 타이핑은 놀라운 수준으로 타입스크립트의 지원을 한 껏 받을수있다. 생각 자체도 매우 진보적이지만 그 생각을 이런 수준으로 구현할 수 있다는 점도 꽤나 충격적이다.  

블록을 조립하는 느낌으로 파이프라인을 설계하는 느낌이 좋았다. 펜으로 그린 그림이 그대로 파이프에 의해 연결된다. 그림과 코드가 잘 매치된다. 명료하고 적은 수의 어휘를 가진 언어의 느낌으로 읽기에도 정리가 되어 보였다.

### 문제는 무엇인가?

#### 메모리

아무래도 퍼포먼스 보다 가독성을 중시하는 느낌으로 코딩하지 보긴 좋았지만 메모리 쪽에 문제가 있었다.  
람다에서는 메모리는 돈이며 돈주고도 못사는 한계가 존재하는데 `rxjs` 가 메모리의 밸류에이션을 더욱 높여주고 있었다.  

#### 러닝커브

이해를 했다고 생각해도 익숙하지 않은 무언가를 다루듯 생각하는데 더 많은 시간을 필요로한다.

## 정리

메모리 이슈 때문에 결국 2개의 버전을 구현했다. `rx` 를 이용한 파이프라인과 일반적인 `if`, `for` 로 내려가는 절차적 코드 모두를 구현했다.

처음에는 `rxjs` 문제로 확신했으나 실제로 두 버전을 모두 구현해서 비교해보니 1.5 ~ 2.5 배 수준인 느낌이다. 사실 난 10배 그 이상을 생각하고 코드를 재 구현했었다.  
메모리 강제 해제가 없는 자바스크립트 자체가 적절하지 않았던 느낌도 있다.  

`rxjs` 는 `mergeMap`을 이해한다면 꽤나 재미있는 코딩 경험을 선사해준다. 그러나 매우 높은 퍼포먼스나 하드웨어의 물리적인 리소스를 엄청나게 끌어다 쓰는 영역에서는 적절하지 않다. 결국 퍼포먼스가 문제가 될 것으로 생각된다.  
맺고 끝는 점이 분명하고 로드가 심하지 않은 마우스 클릭 스트림과 같은 영역이 역시 적절할 것으로 보인다.
